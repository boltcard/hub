{
	order rate_limit before basicauth
	email cert@{$HOST_DOMAIN}
}

https://{$HOST_DOMAIN} {
	tls {
		issuer acme {
			dir https://acme-v02.api.letsencrypt.org/directory
		}
		issuer acme {
			dir https://acme.zerossl.com/v2/DV90
		}
	}

	header {
		Access-Control-Allow-Origin *
		Access-Control-Allow-Methods "GET, POST, OPTIONS"
		Access-Control-Allow-Headers "Authorization, Content-Type"
	}

	@auth_paths {
		path /admin/login/ /admin/api/auth/login /auth
	}
	handle @auth_paths {
		rate_limit {
			zone auth_zone {
				key {remote_host}
				events 10
				window 1m
			}
		}
		reverse_proxy card:8000
	}

	@api_paths {
		path /create /payinvoice /addinvoice /ln /cb
	}
	handle @api_paths {
		rate_limit {
			zone api_zone {
				key {remote_host}
				events 30
				window 1m
			}
		}
		reverse_proxy card:8000
	}

	handle {
		encode zstd
		reverse_proxy card:8000
	}
}
