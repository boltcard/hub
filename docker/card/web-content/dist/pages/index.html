<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bolt Card Hub - Phoenix Edition</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>

<body>
    <ul class="list-group">
        <li class="list-group-item"><a href="/admin/">admin page</a></li>
        <li class="list-group-item"><a href="/bolt12/">bolt12 test page</a></li>
    </ul>

    <h3>Web NFC test</h3>

<div id="log-msgs"></div>

<script>
function log(log_message) {
  var theDiv = document.getElementById("log-msgs");
  theDiv.appendChild(document.createTextNode(log_message));
  theDiv.appendChild(document.createElement('br'));
}

log("start")

document.addEventListener("DOMContentLoaded", async () => {
            try {
              
                var nfcSupported = 'NDEFReader' in window;
                if (!nfcSupported) {
                    log("NFCNotSupported");
                }
                else {
                    log("WaitingForPermission");
                    var granted = (await navigator.permissions.query({ name: 'nfc' })).state === 'granted';
                    if (granted)
                    {
                        log("WaitingForCard");
                        startScan();
                    }
                  }
                }
                catch (e) {
                handleError(e);
                }
              }
            ) 

async function startScan() {
    log("Starting scan");
  
    try {
      abortController = new AbortController();
      abortController.signal.onabort = () => log("WaitingForCard");
    
      const ndef = new NDEFReader();
      await ndef.scan({ signal: abortController.signal })
      log("Scan started");
  
      ndef.addEventListener("readingerror", () => {
        log("Cannot read data from the NFC tag.");
      });
  
      ndef.addEventListener("reading", ({ message, serialNumber }) => {
        log(`*** card read ***`);
        log(`Serial Number: ${serialNumber}`);
        log(`Records: (${message.records.length})`);
        const decoder = new TextDecoder();

        const record = message.records[0];
        if (message.records.length === 0)
        {
          log("Card is blank");
          return;
        }

        const textDecoder = new TextDecoder('utf-8');
        const decoded = textDecoder.decode(record.data);
        log("decoded: " + decoded)
//      await showBalance(decoded);

      });
    } catch (error) {
        log("error: " + error);
    }
  }

</script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>

</html>